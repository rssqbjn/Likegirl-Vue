# Like Girl v5.2.0 云函数部署步骤

## 项目概述

本项目是一个基于腾讯云开发的恋爱主题网站，包含留言板、相册、恋爱清单、文章管理等功能模块。

## 云函数列表

- **auth**: 认证模块 - 管理员登录、Token验证
- **admin**: 管理员模块 - 仪表板、数据管理、系统管理
- **leaving**: 留言板模块 - 留言的增删查改
- **loveImg**: 恋爱相册模块 - 相册图片管理
- **lovelist**: 恋爱清单模块 - 恋爱清单项目管理
- **article**: 文章模块 - 文章的增删查改
- **settings**: 设置模块 - 系统设置管理
- **ipManage**: IP管理模块 - IP封禁和访问记录管理

## 部署前准备

### 1. 环境要求

- Node.js 18.15+ 
- 腾讯云开发账号
- 已创建云开发环境

### 2. 获取环境ID

1. 登录 [腾讯云开发控制台](https://console.cloud.tencent.com/tcb)
2. 选择或创建一个环境
3. 复制环境ID（格式如：`your-env-id-xxxxx`）

### 3. 安装CloudBase CLI

```bash
npm install -g @cloudbase/cli
```

## 部署步骤

### 第一步：配置环境

1. **修改环境配置**
   
   编辑根目录的 `cloudbaserc.json` 文件：
   ```json
   {
     "version": "2.0",
     "envId": "你的实际环境ID",  // 替换为你的环境ID
     "$schema": "https://framework-1258016615.tcloudbaseapp.com/schema/latest.json",
     "framework": {
       "name": "cloudbase-vue-template",
       "plugins": {
         "client": {
           "use": "@cloudbase/framework-plugin-website",
           "inputs": {
             "outputPath": "dist",
             "buildCommand": "npm run build"
           }
         }
       }
     }
   }
   ```

2. **配置安全码及JWT密钥**
   
   编辑 `cloudfunctions/settings/config.js` 文件：
   ```javascript
   module.exports = {
     securityCode: '你的安全码',  // 设置一个复杂的安全码
     // 其他配置...
   }
   ```
   
   编辑 `cloudfunctions/auth/index.js` 文件：
   ```javascript
    const JWT_SECRET = '你的自定义密钥'
    const JWT_EXPIRES_IN = '24h' // token过期时间
   ```


### 第二步：登录云开发

```bash
# 登录腾讯云
tcb login

# 选择登录方式（推荐使用微信扫码）
```

### 第三步：初始化数据库

在云开发控制台创建以下数据库集合：

```bash
# 必需的数据库集合
- login          # 管理员账户信息
- leaving        # 留言数据
- loveImg        # 恋爱相册数据
- lovelist       # 恋爱清单数据
- article        # 文章数据
- text           # 基础设置数据
- about          # 关于页面数据
- diySet         # 自定义设置数据
- leavSet        # 留言设置数据
- ipBan          # IP封禁记录
- illegalAccess  # 非法访问记录
- login_attempts # 登录尝试记录
- admin_logs     # 管理员操作日志
- token_verify_failures     # 管理员令牌验证失败记录
- ip_operation_logs     # 云函数自动封禁记录

```

### 第四步：部署云函数

#### 方法一：批量部署（推荐）

```bash
# 进入云函数目录
cd cloudfunctions

# 部署所有云函数
tcb functions:deploy --all
```

#### 方法二：逐个部署

```bash
# 部署认证模块
tcb functions:deploy auth

# 部署管理员模块
tcb functions:deploy admin

# 部署留言板模块
tcb functions:deploy leaving

# 部署相册模块
tcb functions:deploy loveImg

# 部署恋爱清单模块
tcb functions:deploy lovelist

# 部署文章模块
tcb functions:deploy article

# 部署设置模块
tcb functions:deploy settings

# 部署IP管理模块
tcb functions:deploy ipManage
```

### 第五步：初始化管理员账户

1. **方式一：通过控制台直接插入数据**
   
   在云开发控制台的数据库 `login` 集合中插入：
   ```json
   {
     "user": "admin",
     "pw": "21232f297a57a5a743894a0e4a801fc3",  // admin的MD5值
   }
   ```

2. **方式二：通过云函数初始化**
   
   调用auth云函数进行初始化：
   ```javascript
   // 前端调用示例
   const result = await app.callFunction({
     name: 'auth',
     data: {
       action: 'initAdmin',
       data: {
         username: 'admin',
         password: 'admin',  // 首次登录后请及时修改
       }
     }
   });
   ```

### 第七步：配置安全规则

为数据库集合配置适当的安全规则：

```javascript
// 示例：leaving集合的安全规则
{
  "read": true,  // 允许读取
  "write": "auth != null"  // 需要认证才能写入
}
```

### 第八步：部署前端项目

配置src\utils\cloudbase.js的const ENV_ID ;
   ```javascript
   const ENV_ID = '你的环境ID'
   ```
```bash
# 返回项目根目录
cd ..

# 安装依赖
npm install

# 构建项目
npm run build

# 部署到云开发静态网站托管
tcb hosting:deploy dist -e 你的环境ID
```

## 部署验证

### 1. 检查云函数状态

```bash
# 查看云函数列表
tcb functions:list

# 查看特定云函数详情
tcb functions:detail auth
```

### 2. 测试云函数

```bash
# 测试认证云函数
tcb functions:invoke auth --data '{"action":"adminLogin","data":{"username":"admin","password":"admin"}}'
```

### 3. 访问网站

通过云开发提供的默认域名或自定义域名访问网站，测试各功能模块。

## 常见问题及解决方案

### 1. 云函数部署失败

**问题**: 部署时提示权限不足
**解决**: 确保已正确登录云开发，并且账户有相应权限

```bash
# 重新登录
tcb logout
tcb login
```

### 2. 数据库连接失败

**问题**: 云函数无法连接数据库
**解决**: 检查环境ID配置是否正确

### 3. 管理员登录失败

**问题**: 无法登录管理后台
**解决**: 
- 检查login集合是否存在管理员数据
- 确认密码MD5加密是否正确
- 检查IP是否被封禁

### 4. 静态资源访问失败

**问题**: 图片等静态资源无法访问
**解决**: 
- 检查云存储配置
- 确认文件上传路径正确
- 配置适当的访问权限

## 环境变量配置

在云函数中可能需要配置的环境变量：

```bash
# 设置环境变量
tcb functions:config:update 云函数名 --env-variables key1=value1,key2=value2
```

常用环境变量：
- `ENV_ID`: 环境ID
- `SECRET_KEY`: JWT密钥
- `ADMIN_QQ`: 管理员QQ
- `SITE_URL`: 网站URL

## 监控和日志

### 查看云函数日志

```bash
# 查看云函数执行日志
tcb functions:log auth

# 实时查看日志
tcb functions:log auth --tail
```

### 监控云函数性能

在云开发控制台的监控页面可以查看：
- 调用次数
- 错误率
- 平均执行时间
- 内存使用情况

## 更新和维护

### 更新云函数

```bash
# 更新单个云函数
tcb functions:deploy auth

# 更新所有云函数
tcb functions:deploy --all
```

### 数据备份

定期备份重要数据：

```bash
# 导出数据库数据
tcb database:export --collection-name leaving --file-path ./backup/leaving.json
```

### 版本管理

建议使用Git管理代码版本，并为每次部署打标签：

```bash
git tag -a v5.2.0 -m "Release version 5.2.0"
git push origin v5.2.0
```

## 安全建议

1. **定期更换管理员密码**
2. **配置IP白名单**（如果需要）
3. **启用HTTPS访问**
4. **定期检查访问日志**
5. **及时更新依赖包**

## 技术支持

如遇到部署问题，可以：

1. 查看[腾讯云开发文档](https://cloud.tencent.com/document/product/876)
2. 查看项目的API文档：`cloudfunctions/API_DOCUMENTATION.md`
3. 检查云函数执行日志
4. 联系技术支持

---

**部署完成后，请及时修改默认管理员密码，并做好数据备份工作！**